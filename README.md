# Dona - Social Data Gathering Platform
Dona is a platform developed to collect and de-identify social data to be later used as part of a research effort to characterize mental wellbeing.

---------

This is a [Next.js](https://nextjs.org/) project bootstrapped with [
`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).

## Background
#TODO

## Installation
#TODO

## Development

#### postgres container:
```bash
# start
docker compose up # docker compose up -d to detach from commandline
# stop
docker compose stop
# tear down
docker compose down
# remove postgres data volume
docker volume rm dona-dev_postgres-data
```

Create a `.env` in the project root containing `DATABASE_URL=postgres://...`  
Default username/password are `dona:password` 

First, run the development server:
```bash
pnpm dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

This project uses [`next/font`](https://nextjs.org/docs/basic-features/font-optimization) to automatically optimize and
load Inter, a custom Google Font.

## Database

#### next/drizzle
__installed packages:__
1. drizzle-orm [docs](https://orm.drizzle.team/docs/overview)
2. drizzle-kit: cli for setup, migrations etc [docs](https://orm.drizzle.team/docs/kit-overview)
3. pg, @types/pg: driver and interfaces 

__relevant files:__
- drizzle.config.ts: global configuration for drizzle ORM. contains path to schema, migrations etc
- drizzle/: contains migrations generated by drizzle-kit as well as the current state of the schema. This needs to be checked into vcs. 
  if this gets corrupted, drizzle-kit won't function properly and might migrate away your data.
- src/db/drizzle.ts: application config, configures postgres connection, provides `db` object used for database access
- src/db/schema.ts: defines the database schema and object relations. migrations are derived from changes to this file. 

__migrating the schema__:
```bash
pnpm drizzle-kit generate # generate migrations from schema
pnpm drizzle-kit migrate # run migrations against database
```
To create a custom migration script, run
```bash
pnpm drizzle-kit generate --custom --name=my-custom-migration
```

#### schema
__considerations:__
- Set up schema according to [this](https://github.com/mbp-lab/dona/tree/main/conf/db/migration/default)
- For `uuid` primary keys, default values are generated on insert by postgres. 
- `uuid` for participantId as well
- datasources `integer` id is also always incremented and set automatically
- `uuid` for donor_id in donations table isn't since it didn't have a not null constraint.

__relations:__
- donations has many conversations
- data_sources has many conversations
- conversations has:
    * one donation
    * one data source
    * many participants
    * many messages
    * many messages_audio
- conversation_participants has one conversation
- messages has one conversation
- messages_audio has one conversation


## Maintenance

The following guidelines and commands allow to upgrade the project and its dependencies, so that it features the latest 
security and performance updates:

1. **Keep `pnpm` up-to-date**:
   ```bash
   pnpm self update
   ```
2. **Update dependencies within the allowed version range**:

   This range is determined upon first installation for each dependency. Updating this way shouldn't cause any breaking changes.
   ```bash
   pnpm update
   ```
   
3. **Check for further outdated dependencies**:

   ‚ö†Ô∏è This will indicate dependencies that are outdated; they might have new major or minor versions available and should be updated
    **one at a time** in order to avoid introducing multiple breaking changes in the codebase at once.
   ```bash
   pnpm outdated
   ```
   Now each outdated dependency can be updated to either a specific version or the latest version with these commands:
    ```bash
    pnpm update <package-name>@2.3.0  // Specific version
    pnpm update <package-name> --latest  // Latest
    ```

4. **Verify Compatibility**:

   After each update, check that the project works as expected and resolve any issues:
   ```bash
   pnpm why <package-name>
   ```

üö® After dependency updates, always execute tests and run the application to ensure all dependencies function correctly.
